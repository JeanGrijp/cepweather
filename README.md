# CEP Weather

Sistema de microservi√ßos em Go que recebe um CEP, identifica a cidade e retorna o clima atual (temperatura em Celsius, Fahrenheit e Kelvin). Implementa **OpenTelemetry (OTEL)** e **Zipkin** para observabilidade e tracing distribu√≠do.

## üèóÔ∏è Arquitetura de Microservi√ßos

O sistema √© composto por **dois servi√ßos independentes** que se comunicam via HTTP, com instrumenta√ß√£o completa de tracing distribu√≠do:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                                          
‚îÇ     Cliente      ‚îÇ                                                          
‚îÇ  (Postman/cURL)  ‚îÇ                                                          
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                                          
         ‚îÇ POST /cep                                                          
         ‚îÇ {"cep": "01001000"}                                                
         ‚ñº                                                                    
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê          
‚îÇ  Servi√ßo A - Input Service (Porta 8081)                         ‚îÇ          
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ          
‚îÇ  ‚îÇ ‚Ä¢ Valida formato do CEP (8 d√≠gitos num√©ricos)              ‚îÇ ‚îÇ          
‚îÇ  ‚îÇ ‚Ä¢ Retorna 422 se inv√°lido                                  ‚îÇ ‚îÇ          
‚îÇ  ‚îÇ ‚Ä¢ Encaminha para Servi√ßo B via HTTP GET                    ‚îÇ ‚îÇ          
‚îÇ  ‚îÇ ‚Ä¢ Propaga contexto OTEL via headers                        ‚îÇ ‚îÇ          
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ          
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò          
         ‚îÇ GET /weather/01001000                                              
         ‚îÇ (com traceparent header)                                           
         ‚ñº                                                                    
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê          
‚îÇ  Servi√ßo B - Weather Service (Porta 8080)                       ‚îÇ          
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ          
‚îÇ  ‚îÇ 1. Busca localiza√ß√£o no ViaCEP                             ‚îÇ ‚îÇ          
‚îÇ  ‚îÇ    ‚îî‚îÄ> Span: "viacep.Lookup" (mede lat√™ncia)              ‚îÇ ‚îÇ          
‚îÇ  ‚îÇ                                                            ‚îÇ ‚îÇ          
‚îÇ  ‚îÇ 2. Busca temperatura na WeatherAPI                        ‚îÇ ‚îÇ          
‚îÇ  ‚îÇ    ‚îî‚îÄ> Span: "weatherapi.CurrentTemperatureC"            ‚îÇ ‚îÇ          
‚îÇ  ‚îÇ                                                            ‚îÇ ‚îÇ          
‚îÇ  ‚îÇ 3. Converte temperaturas (C ‚Üí F ‚Üí K)                     ‚îÇ ‚îÇ          
‚îÇ  ‚îÇ                                                            ‚îÇ ‚îÇ          
‚îÇ  ‚îÇ 4. Retorna JSON com cidade + temperaturas                 ‚îÇ ‚îÇ          
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ          
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò          
         ‚îÇ                                                                    
         ‚ñº                                                                    
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê          
‚îÇ  Resposta Final                                                 ‚îÇ          
‚îÇ  {                                                              ‚îÇ          
‚îÇ    "city": "S√£o Paulo",                                         ‚îÇ          
‚îÇ    "temp_C": 28.5,                                              ‚îÇ          
‚îÇ    "temp_F": 83.3,                                              ‚îÇ          
‚îÇ    "temp_K": 301.5                                              ‚îÇ          
‚îÇ  }                                                              ‚îÇ          
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò          
                                                                              
         ‚îÇ                                                                    
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                            
                                ‚ñº                                            
                       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                   
                       ‚îÇ  Zipkin Server  ‚îÇ                                   
                       ‚îÇ  (Porta 9411)   ‚îÇ                                   
                       ‚îÇ                 ‚îÇ                                   
                       ‚îÇ  ‚Ä¢ UI Web       ‚îÇ                                   
                       ‚îÇ  ‚Ä¢ Query API    ‚îÇ                                   
                       ‚îÇ  ‚Ä¢ Visualiza√ß√£o ‚îÇ                                   
                       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                   
                                                                              
    Servi√ßo A e B enviam spans OTEL via HTTP para Zipkin                     
```

### üìä Componentes do Sistema

#### üîµ Servi√ßo A - Input Service (Porta 8081)
- **Responsabilidade**: Valida√ß√£o de entrada e orquestra√ß√£o
- **Endpoint**: `POST /`
- **Valida√ß√µes**:
  - CEP deve ser string de exatamente 8 d√≠gitos num√©ricos
  - Retorna `422` se formato inv√°lido
- **Comportamento**:
  - Encaminha requisi√ß√£o v√°lida para Servi√ßo B via `GET /weather/{cep}`
  - Propaga contexto de tracing via header `traceparent` (W3C Trace Context)
  - Retorna resposta do Servi√ßo B ao cliente
- **Observabilidade**: Cria span raiz para rastreamento end-to-end

#### üü¢ Servi√ßo B - Weather Service (Porta 8080)
- **Responsabilidade**: Orquestra√ß√£o de APIs externas e l√≥gica de neg√≥cio
- **Endpoint**: `GET /weather/{cep}`
- **Integra√ß√µes**:
  1. **ViaCEP API**: Busca localiza√ß√£o (cidade/estado) pelo CEP
  2. **WeatherAPI**: Busca temperatura atual da cidade
- **Processamento**:
  - Valida formato do CEP (8 d√≠gitos)
  - Retorna `404` se CEP n√£o encontrado no ViaCEP
  - Converte temperatura: Celsius ‚Üí Fahrenheit ‚Üí Kelvin
  - Combina dados de localiza√ß√£o + clima em uma resposta unificada
- **Observabilidade**: 
  - Span `viacep.Lookup` com atributos: cep, city, state
  - Span `weatherapi.CurrentTemperatureC` com atributos: city, state, temp_c

#### üü° Zipkin - Distributed Tracing (Porta 9411)
- **Responsabilidade**: Coleta, armazenamento e visualiza√ß√£o de traces
- **Interface Web**: `http://localhost:9411`
- **Funcionalidades**:
  - Visualiza√ß√£o de traces end-to-end
  - An√°lise de lat√™ncia por servi√ßo/opera√ß√£o
  - Detec√ß√£o de gargalos e erros
  - Query API para busca de traces

## üåê Ambientes de Execu√ß√£o

### üê≥ Ambiente Local (Sistema Completo)

Execute todo o sistema localmente com Docker Compose:

```bash
make docker-watch
```

**Servi√ßos dispon√≠veis:**
- **Servi√ßo A (Input)**: `http://localhost:8081` - Ponto de entrada principal
- **Servi√ßo B (Weather)**: `http://localhost:8080` - API de clima (pode ser acessado diretamente)
- **Zipkin UI**: `http://localhost:9411` - Interface de tracing distribu√≠do

### ‚òÅÔ∏è API em Produ√ß√£o (Cloud Run)

> **Nota**: Atualmente apenas o **Servi√ßo B** est√° em produ√ß√£o. O Servi√ßo A roda apenas localmente.

**Base URL:** `https://cepweather-763272253855.us-central1.run.app`

#### Endpoints Dispon√≠veis (Servi√ßo B)

##### 1. Consultar Temperatura por CEP
```http
GET /weather/{cep}
```

**Exemplo de requisi√ß√£o com CEP v√°lido:**
```bash
curl https://cepweather-763272253855.us-central1.run.app/weather/54735220
```

**Resposta de sucesso (200 OK):**
```json
{
  "city": "S√£o Louren√ßo da Mata",
  "temp_C": 28.5,
  "temp_F": 83.3,
  "temp_K": 301.5
}
```

**Respostas de erro:**

| Status | Mensagem | Descri√ß√£o |
|--------|----------|-----------|
| `422` | `{"message":"invalid zipcode"}` | CEP com formato inv√°lido (tamanho incorreto, caracteres especiais, etc.) |
| `404` | `{"message":"can not find zipcode"}` | CEP n√£o encontrado na base de dados do ViaCEP |
| `500` | `{"message":"internal server error"}` | Erro inesperado no servidor ou nas APIs externas |

**Exemplos de erros:**

```bash
# CEP n√£o encontrado
curl https://cepweather-763272253855.us-central1.run.app/weather/53424543
# Resposta: 404 {"message":"can not find zipcode"}

# CEP com formato inv√°lido (muito longo)
curl https://cepweather-763272253855.us-central1.run.app/weather/012345678
# Resposta: 422 {"message":"invalid zipcode"}
```

#### 2. Health Check
```http
GET /healthz
```

**Exemplo de requisi√ß√£o:**
```bash
curl https://cepweather-763272253855.us-central1.run.app/healthz
```

**Resposta:**
```
ok
```

### CEPs para Teste

| CEP | Cidade | Estado | Status Esperado |
|-----|--------|--------|-----------------|
| `01001000` | S√£o Paulo | SP | ‚úÖ 200 OK |
| `20040020` | Rio de Janeiro | RJ | ‚úÖ 200 OK |
| `30140071` | Belo Horizonte | MG | ‚úÖ 200 OK |
| `80010000` | Curitiba | PR | ‚úÖ 200 OK |
| `54735220` | S√£o Louren√ßo da Mata | PE | ‚úÖ 200 OK |
| `53424543` | CEP n√£o encontrado | - | ‚ùå 404 Not Found |
| `00000000` | CEP inv√°lido | - | ‚ùå 404 Not Found |
| `123` | Formato inv√°lido | - | ‚ùå 422 Invalid |

## Requisitos

- Go 1.22 ou superior (para execu√ß√£o local sem Docker)
- Docker e Docker Compose (para a execu√ß√£o containerizada)
- Conta na [WeatherAPI](https://www.weatherapi.com/) e chave de acesso (`WEATHER_API_KEY`)
- Conta Google Cloud com o SDK `gcloud` configurado (para deploy)

## Vari√°veis de ambiente

| Nome                    | Obrigat√≥rio | Default                              | Descri√ß√£o                                |
|-------------------------|-------------|--------------------------------------|-------------------------------------------|
| `WEATHER_API_KEY`       | Sim         | ‚Äî                                    | Chave da WeatherAPI.                      |
| `VIACEP_BASE_URL`       | N√£o         | `https://viacep.com.br/ws`           | Endpoint do servi√ßo ViaCEP.               |
| `WEATHER_API_BASE_URL`  | N√£o         | `https://api.weatherapi.com/v1`      | Endpoint da WeatherAPI.                   |
| `SERVICE_B_URL`         | N√£o         | `http://localhost:8080`              | URL do Servi√ßo B (usado pelo Servi√ßo A). |
| `ZIPKIN_URL`            | N√£o         | `http://zipkin:9411/api/v2/spans`    | URL do exportador Zipkin.                |
| `PORT`                  | N√£o         | `8080` (B) / `8081` (A)              | Porta exposta pelos servidores HTTP.      |

## üöÄ Execu√ß√£o local

### Op√ß√£o 1: Sistema Completo com Docker Compose (Recomendado)

Esta √© a forma mais simples de rodar todo o sistema com tracing distribu√≠do:

1. Crie um arquivo `.env` na raiz do projeto:
```bash
WEATHER_API_KEY=sua_chave_aqui
```

2. Execute o sistema completo:
```bash
make docker-watch
```

Isso ir√° iniciar:
- **Servi√ßo A (Input)** em `http://localhost:8081`
- **Servi√ßo B (Weather)** em `http://localhost:8080`
- **Zipkin UI** em `http://localhost:9411`

3. Teste o sistema completo (via Servi√ßo A):
```bash
curl -X POST http://localhost:8081 \
  -H "Content-Type: application/json" \
  -d '{"cep": "01001000"}'
```

Resposta esperada:
```json
{
  "city": "S√£o Paulo",
  "temp_C": 28.5,
  "temp_F": 83.3,
  "temp_K": 301.5
}
```

4. Visualize os traces no Zipkin:
   - Abra `http://localhost:9411` no navegador
   - Clique em "Run Query" para ver os traces
   - Explore o trace distribu√≠do Service-A ‚Üí Service-B ‚Üí ViaCEP/WeatherAPI

### Op√ß√£o 2: Executar servi√ßos individuais (sem Docker)

#### Servi√ßo B (Weather API):
```bash
export WEATHER_API_KEY=sua_chave_aqui
make run
```

#### Servi√ßo A (Input Service):
```bash
make run-input-service
```

Teste direto no Servi√ßo B:
```bash
curl http://localhost:8080/weather/01001000
```

Teste via Servi√ßo A:
```bash
curl -X POST http://localhost:8081 \
  -H "Content-Type: application/json" \
  -d '{"cep": "01001000"}'
```

## üîç Observabilidade e Tracing Distribu√≠do

O sistema implementa **OpenTelemetry (OTEL)** para instrumenta√ß√£o autom√°tica e **Zipkin** para visualiza√ß√£o de traces distribu√≠dos, permitindo rastrear requisi√ß√µes atrav√©s de m√∫ltiplos servi√ßos.

### üéØ Por que Tracing Distribu√≠do?

Em arquiteturas de microservi√ßos, uma √∫nica requisi√ß√£o do usu√°rio pode atravessar m√∫ltiplos servi√ßos. O tracing distribu√≠do permite:

- üîç **Visibilidade end-to-end**: Ver o caminho completo de uma requisi√ß√£o
- ‚è±Ô∏è **An√°lise de lat√™ncia**: Identificar quais servi√ßos/opera√ß√µes s√£o lentos
- üêõ **Debug facilitado**: Rastrear erros atrav√©s de m√∫ltiplos servi√ßos
- üìä **M√©tricas de performance**: Medir SLA e identificar gargalos

### üì° O que √© Instrumentado?

#### Servi√ßo A (Input Service)
- **Span HTTP**: Toda requisi√ß√£o POST cria um span raiz
- **Propaga√ß√£o de contexto**: Injeta `traceparent` header ao chamar Servi√ßo B

#### Servi√ßo B (Weather Service)
- **Span HTTP**: Recebe contexto do Servi√ßo A via header
- **Span `viacep.Lookup`**: Mede tempo de consulta ao ViaCEP
  - Atributos: `cep`, `city`, `state`
- **Span `weatherapi.CurrentTemperatureC`**: Mede tempo de consulta √† WeatherAPI
  - Atributos: `city`, `state`, `temp_c`

### üñ•Ô∏è Como Visualizar Traces no Zipkin

1. **Inicie o sistema completo**:
```bash
make docker-watch
```

2. **Gere traces fazendo requisi√ß√µes**:
```bash
# Requisi√ß√£o de sucesso
curl -X POST http://localhost:8081 \
  -H "Content-Type: application/json" \
  -d '{"cep": "01001000"}'

# CEP n√£o encontrado
curl -X POST http://localhost:8081 \
  -H "Content-Type: application/json" \
  -d '{"cep": "99999999"}'

# CEP inv√°lido
curl -X POST http://localhost:8081 \
  -H "Content-Type: application/json" \
  -d '{"cep": "123"}'
```

3. **Acesse a UI do Zipkin**: `http://localhost:9411`

4. **Explore os traces**:
   - Clique em **"Run Query"** para buscar traces recentes
   - Selecione um trace na lista para ver detalhes
   - Visualize a **linha do tempo** (timeline) de cada span
   - Clique em cada span para ver **atributos** e **tags**

### üìä Exemplo de Trace Completo

Quando voc√™ faz uma requisi√ß√£o bem-sucedida, o Zipkin mostra:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ service-a: POST / (200ms total)                                     ‚îÇ
‚îÇ ‚îú‚îÄ http.method: POST                                                ‚îÇ
‚îÇ ‚îú‚îÄ http.url: /                                                      ‚îÇ
‚îÇ ‚îî‚îÄ http.status_code: 200                                            ‚îÇ
‚îÇ                                                                     ‚îÇ
‚îÇ   ‚îî‚îÄ> service-b: GET /weather/01001000 (190ms)                     ‚îÇ
‚îÇ       ‚îú‚îÄ http.method: GET                                           ‚îÇ
‚îÇ       ‚îú‚îÄ http.url: /weather/01001000                                ‚îÇ
‚îÇ       ‚îî‚îÄ http.status_code: 200                                      ‚îÇ
‚îÇ                                                                     ‚îÇ
‚îÇ         ‚îú‚îÄ> viacep.Lookup (45ms)                                    ‚îÇ
‚îÇ         ‚îÇ   ‚îú‚îÄ cep: 01001000                                        ‚îÇ
‚îÇ         ‚îÇ   ‚îú‚îÄ city: S√£o Paulo                                      ‚îÇ
‚îÇ         ‚îÇ   ‚îî‚îÄ state: SP                                            ‚îÇ
‚îÇ         ‚îÇ                                                           ‚îÇ
‚îÇ         ‚îî‚îÄ> weatherapi.CurrentTemperatureC (140ms)                  ‚îÇ
‚îÇ             ‚îú‚îÄ city: S√£o Paulo                                      ‚îÇ
‚îÇ             ‚îú‚îÄ state: SP                                            ‚îÇ
‚îÇ             ‚îî‚îÄ temp_c: 28.5                                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Timeline:
|----service-a (200ms)-------------------------------------------|
  |----service-b (190ms)-------------------------------------|
    |--viacep (45ms)--|
                        |----weatherapi (140ms)----------|
```

### üè∑Ô∏è Atributos Capturados nos Spans

| Span | Atributos | Exemplo |
|------|-----------|---------|
| `POST /` | `http.method`, `http.url`, `http.status_code` | `POST`, `/`, `200` |
| `GET /weather/{cep}` | `http.method`, `http.url`, `http.status_code` | `GET`, `/weather/01001000`, `200` |
| `viacep.Lookup` | `cep`, `city`, `state` | `01001000`, `S√£o Paulo`, `SP` |
| `weatherapi.CurrentTemperatureC` | `city`, `state`, `temp_c` | `S√£o Paulo`, `SP`, `28.5` |

### üîß Propaga√ß√£o de Contexto (W3C Trace Context)

O sistema usa o padr√£o **W3C Trace Context** para propagar o contexto de tracing entre servi√ßos:

```http
# Servi√ßo A envia para Servi√ßo B:
GET /weather/01001000 HTTP/1.1
Host: service-b:8080
traceparent: 00-4bf92f3577b34da6a3ce929d0e0e4736-00f067aa0ba902b7-01
```

**Formato do traceparent**:
```
00-<trace-id>-<parent-span-id>-<trace-flags>
‚îÇ  ‚îÇ          ‚îÇ                 ‚îÇ
‚îÇ  ‚îÇ          ‚îÇ                 ‚îî‚îÄ Flags (01 = sampled)
‚îÇ  ‚îÇ          ‚îî‚îÄ ID do span pai (16 bytes hex)
‚îÇ  ‚îî‚îÄ ID do trace (32 bytes hex)
‚îî‚îÄ Vers√£o (sempre 00)
```

Isso garante que todos os spans sejam correlacionados ao mesmo trace, mesmo atravessando m√∫ltiplos servi√ßos.

### üöÄ Recursos Avan√ßados do Zipkin

- **Filtros de busca**: Busque traces por service name, span name, duration, etc.
- **Depend√™ncias**: Visualize o grafo de depend√™ncias entre servi√ßos
- **Compara√ß√£o de traces**: Compare traces lentos vs r√°pidos
- **JSON export**: Exporte traces para an√°lise offline

## Testes

### Executar todos os testes

```bash
make test
```

Ou diretamente com Go:

```bash
GOCACHE=$(pwd)/.cache go test ./...
```

### Cobertura de testes

```bash
go test -cover ./...
```

## Docker

### Build da imagem

```bash
make docker-build
```

Ou diretamente:

```bash
docker build -t cepweather .
```

### Executar container

```bash
make docker-run WEATHER_API_KEY=sua_chave_aqui
```

Ou diretamente:

```bash
docker run --rm -p 8080:8080 -e WEATHER_API_KEY=sua_chave_aqui cepweather
```

### Docker Compose

Com arquivo `.env` configurado:

```bash
make docker-watch
```

Ou manualmente:

```bash
export WEATHER_API_KEY=coloque_sua_chave_aqui
docker compose up --build
```

Para rodar em background:

```bash
docker compose up -d
```

Para parar:

```bash
docker compose down
```

## Deploy no Google Cloud Run

### Pr√©-requisitos

1. Instalar o Google Cloud SDK:
   ```bash
   brew install google-cloud-sdk
   ```

2. Autenticar-se no Google Cloud:
   ```bash
   gcloud auth login
   ```

3. Configurar o projeto:
   ```bash
   gcloud config set project SEU_PROJETO_ID
   ```

### Deploy Simplificado (Recomendado)

Deploy direto do c√≥digo-fonte:

```bash
gcloud run deploy cepweather \
  --source . \
  --platform managed \
  --region us-central1 \
  --allow-unauthenticated \
  --set-env-vars WEATHER_API_KEY=sua_chave_aqui
```

### Deploy via Artifact Registry (Alternativo)

1. Criar reposit√≥rio no Artifact Registry (apenas uma vez):
   ```bash
   gcloud artifacts repositories create cepweather \
     --repository-format=docker \
     --location=us-central1
   ```

2. Fazer build e push da imagem:
   ```bash
   gcloud builds submit --tag us-central1-docker.pkg.dev/SEU_PROJETO/cepweather/app
   ```

3. Fazer deploy:
   ```bash
   gcloud run deploy cepweather \
     --image us-central1-docker.pkg.dev/SEU_PROJETO/cepweather/app \
     --platform managed \
     --region us-central1 \
     --allow-unauthenticated \
     --set-env-vars WEATHER_API_KEY=sua_chave_aqui
   ```

### Gerenciar o servi√ßo

Ver logs:
```bash
gcloud run services logs read cepweather --region us-central1
```

Atualizar vari√°veis de ambiente:
```bash
gcloud run services update cepweather \
  --region us-central1 \
  --set-env-vars WEATHER_API_KEY=nova_chave
```

Deletar o servi√ßo:
```bash
gcloud run services delete cepweather --region us-central1
```

### Teste p√≥s-deploy

Ap√≥s o deploy, a URL do servi√ßo ser√° exibida. Teste com:

```bash
curl https://SEU_ENDPOINT/weather/01001000
```

## üõ†Ô∏è Comandos Make Dispon√≠veis

| Comando | Descri√ß√£o |
|---------|-----------|
| `make run` | Executa o Servi√ßo B (Weather API) localmente |
| `make run-input-service` | Executa o Servi√ßo A (Input Service) localmente |
| `make test` | Executa os testes unit√°rios |
| `make build` | Compila os bin√°rios de ambos os servi√ßos |
| `make docker-build` | Cria as imagens Docker de ambos os servi√ßos |
| `make docker-run` | Executa o container do Servi√ßo B |
| `make docker-watch` | **Sistema completo** com Docker Compose + Zipkin |
| `make compose` | Executa com Docker Compose |
| `make clean` | Remove arquivos compilados e cache |

## üìù Testando o Sistema

### üîµ Fluxo Completo: Servi√ßo A ‚Üí Servi√ßo B (Recomendado)

O Servi√ßo A √© o **ponto de entrada principal** do sistema e implementa a valida√ß√£o de CEP antes de encaminhar para o Servi√ßo B.

#### ‚úÖ 1. CEP V√°lido (Sucesso)
```bash
curl -X POST http://localhost:8081 \
  -H "Content-Type: application/json" \
  -d '{"cep": "01001000"}'
```

**Resposta esperada (200 OK):**
```json
{
  "city": "S√£o Paulo",
  "temp_C": 28.5,
  "temp_F": 83.3,
  "temp_K": 301.5
}
```

**O que acontece internamente:**
1. Servi√ßo A valida formato do CEP ‚úÖ
2. Servi√ßo A faz `GET http://service-b:8080/weather/01001000`
3. Servi√ßo B busca localiza√ß√£o no ViaCEP
4. Servi√ßo B busca temperatura na WeatherAPI
5. Servi√ßo B retorna JSON com city + temperaturas
6. Servi√ßo A repassa resposta ao cliente

#### ‚ùå 2. CEP com Formato Inv√°lido (422)
```bash
curl -X POST http://localhost:8081 \
  -H "Content-Type: application/json" \
  -d '{"cep": "123"}'
```

**Resposta esperada (422 Unprocessable Entity):**
```json
{
  "message": "invalid zipcode"
}
```

**Por que 422?** 
- CEP tem menos de 8 d√≠gitos
- Valida√ß√£o falha no **Servi√ßo A**
- Requisi√ß√£o n√£o chega ao Servi√ßo B

#### ‚ùå 3. CEP V√°lido mas N√£o Encontrado (404)
```bash
curl -X POST http://localhost:8081 \
  -H "Content-Type: application/json" \
  -d '{"cep": "99999999"}'
```

**Resposta esperada (404 Not Found):**
```json
{
  "message": "can not find zipcode"
}
```

**O que acontece:**
1. Servi√ßo A valida formato ‚úÖ (8 d√≠gitos)
2. Servi√ßo A encaminha para Servi√ßo B
3. Servi√ßo B consulta ViaCEP
4. ViaCEP retorna `{"erro": "true"}` (CEP n√£o existe)
5. Servi√ßo B retorna 404
6. Servi√ßo A repassa o 404 ao cliente

### üü¢ Acesso Direto ao Servi√ßo B (Bypass)

Voc√™ tamb√©m pode testar o Servi√ßo B diretamente, sem passar pelo Servi√ßo A:

```bash
# Via GET direto no Servi√ßo B
curl http://localhost:8080/weather/01001000
```

**Diferen√ßa:**
- ‚úÖ **Via Servi√ßo A (POST)**: Valida√ß√£o de CEP + Tracing distribu√≠do completo
- ‚ö†Ô∏è **Direto no Servi√ßo B (GET)**: Sem valida√ß√£o pr√©via, apenas tracing do Servi√ßo B

### üß™ Collection Postman Completa

Importe essa collection no Postman para testar todos os cen√°rios:

#### üìã Requests para Ambiente Local

##### 1. [Servi√ßo A] POST CEP V√°lido
- **Method:** `POST`
- **URL:** `http://localhost:8081`
- **Headers:** 
  ```
  Content-Type: application/json
  ```
- **Body (raw JSON):**
  ```json
  {
    "cep": "01001000"
  }
  ```
- **Resposta esperada:** `200 OK` com city + temperaturas

##### 2. [Servi√ßo A] POST CEP Inv√°lido (Formato)
- **Method:** `POST`
- **URL:** `http://localhost:8081`
- **Headers:** 
  ```
  Content-Type: application/json
  ```
- **Body (raw JSON):**
  ```json
  {
    "cep": "123"
  }
  ```
- **Resposta esperada:** `422 Unprocessable Entity`

##### 3. [Servi√ßo A] POST CEP N√£o Encontrado
- **Method:** `POST`
- **URL:** `http://localhost:8081`
- **Headers:** 
  ```
  Content-Type: application/json
  ```
- **Body (raw JSON):**
  ```json
  {
    "cep": "99999999"
  }
  ```
- **Resposta esperada:** `404 Not Found`

##### 4. [Servi√ßo B] GET Direto (Bypass do A)
- **Method:** `GET`
- **URL:** `http://localhost:8080/weather/54735220`
- **Headers:** Nenhum
- **Resposta esperada:** `200 OK` com city + temperaturas

##### 5. [Servi√ßo A] Health Check
- **Method:** `GET`
- **URL:** `http://localhost:8081/healthz`
- **Headers:** Nenhum
- **Resposta esperada:** `200 OK` com body `ok`

##### 6. [Servi√ßo B] Health Check
- **Method:** `GET`
- **URL:** `http://localhost:8080/healthz`
- **Headers:** Nenhum
- **Resposta esperada:** `200 OK` com body `ok`

#### ‚òÅÔ∏è Requests para Produ√ß√£o (Cloud Run - Apenas Servi√ßo B)

> **Nota**: O Servi√ßo A n√£o est√° em produ√ß√£o, apenas o Servi√ßo B.

##### 1. [Produ√ß√£o] GET CEP V√°lido
- **Method:** `GET`
- **URL:** `https://cepweather-763272253855.us-central1.run.app/weather/54735220`
- **Headers:** Nenhum
- **Resposta esperada:** `200 OK`

##### 2. [Produ√ß√£o] GET CEP N√£o Encontrado
- **Method:** `GET`
- **URL:** `https://cepweather-763272253855.us-central1.run.app/weather/99999999`
- **Headers:** Nenhum
- **Resposta esperada:** `404 Not Found`

##### 3. [Produ√ß√£o] Health Check
- **Method:** `GET`
- **URL:** `https://cepweather-763272253855.us-central1.run.app/healthz`
- **Headers:** Nenhum
- **Resposta esperada:** `200 OK` com body `ok`

### üìä Matriz de Testes Recomendada

| # | Cen√°rio | Endpoint | Body/Param | Status | Response |
|---|---------|----------|------------|--------|----------|
| 1 | ‚úÖ CEP v√°lido (S√£o Paulo) | `POST http://localhost:8081` | `{"cep":"01001000"}` | 200 | City + Temps |
| 2 | ‚úÖ CEP v√°lido (Rio) | `POST http://localhost:8081` | `{"cep":"20040020"}` | 200 | City + Temps |
| 3 | ‚úÖ CEP v√°lido (Recife) | `POST http://localhost:8081` | `{"cep":"50010000"}` | 200 | City + Temps |
| 4 | ‚ùå CEP curto (3 d√≠gitos) | `POST http://localhost:8081` | `{"cep":"123"}` | 422 | Invalid zipcode |
| 5 | ‚ùå CEP longo (9 d√≠gitos) | `POST http://localhost:8081` | `{"cep":"012345678"}` | 422 | Invalid zipcode |
| 6 | ‚ùå CEP n√£o num√©rico | `POST http://localhost:8081` | `{"cep":"abcd1234"}` | 422 | Invalid zipcode |
| 7 | ‚ùå CEP n√£o encontrado | `POST http://localhost:8081` | `{"cep":"99999999"}` | 404 | Cannot find zipcode |
| 8 | ‚úÖ Direto no Servi√ßo B | `GET http://localhost:8080/weather/01001000` | - | 200 | City + Temps |
| 9 | ‚úÖ Health Check A | `GET http://localhost:8081/healthz` | - | 200 | ok |
| 10 | ‚úÖ Health Check B | `GET http://localhost:8080/healthz` | - | 200 | ok |

## üêõ Tratamento de Erros

A API trata corretamente os seguintes cen√°rios de erro:

### 1. CEP com formato inv√°lido (422)
- CEP com menos ou mais de 8 d√≠gitos
- CEP com letras ou caracteres especiais
- Retorna: `{"message":"invalid zipcode"}`

### 2. CEP n√£o encontrado (404)
- CEP com formato v√°lido mas n√£o existe na base do ViaCEP
- Retorna: `{"message":"can not find zipcode"}`

### 3. Erros de APIs externas (500)
- Timeout na comunica√ß√£o com ViaCEP ou WeatherAPI
- Erro de parsing de resposta
- Retorna: `{"message":"internal server error"}`

### 4. Rotas n√£o encontradas (404)
- Acesso a endpoints inexistentes
- Retorna resposta padr√£o do servidor

## üîß Melhorias Implementadas

### Corre√ß√£o de Bug - ViaCEP Response
O ViaCEP retorna o campo `"erro"` como string `"true"` em vez de boolean quando um CEP n√£o √© encontrado. A aplica√ß√£o foi corrigida para tratar ambos os casos:

```go
// Trata tanto "erro": true quanto "erro": "true"
hasError := false
if payload.Erro != nil {
    switch v := payload.Erro.(type) {
    case bool:
        hasError = v
    case string:
        hasError = v == "true"
    }
}
```

Isso evita erros 500 quando CEPs inv√°lidos s√£o consultados e retorna corretamente 404 com a mensagem apropriada.
